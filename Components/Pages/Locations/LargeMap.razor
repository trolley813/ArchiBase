@page "/locations/{id:guid}/map"
@using Microsoft.EntityFrameworkCore
@inject ModelContext ModelContext
@inject IStringLocalizer<LargeMap> Loc
@inject IJSRuntime JSRuntime

@if (location != null)
{
    <ArchibasePageTitle Title=@($"{Loc["Large map for location"]}: {location.Name}") />

    @if (!loaded)
    {
        <RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.Center" Wrap="FlexWrap.Wrap">
    <RadzenText>@Loc["Loading data..."]</RadzenText>
    <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false"
        Mode="ProgressBarMode.Indeterminate" />
</RadzenStack>
    }

    <LeafletMap @ref="map" Style="width: 90%; height: 90%" OnMarkerClick="args => OnMarkerClick(args)"
        BuildingMarkers="markers">
    </LeafletMap>

}

@code
{
    bool loaded = false;
    class BuildingInfo
    {
        public Guid BuildingId { get; set; }
        public BuildingEventType? CurrentStatus { get; set; }
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public string Label { get; set; }
        public bool HasPhotos { get; set; }
    }

    [Parameter]
    public Guid Id { get; set; }

    LeafletMap map;

    Location? location;

    List<BuildingMarker> markers = [];

    protected override async Task OnInitializedAsync()
    {
        location = ModelContext.Locations.FirstOrDefault(loc => loc.Id == Id);
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            loaded = false;

            markers = ModelContext.Buildings
            .AsNoTracking()
            .Include(b => b.Events)
            .Include(b => b.ActualCard)
            .ThenInclude(c => c.StreetAddresses)
            .ThenInclude(a => a.Street)
            .Where(b => b.Location == location)
            .Select(b => new BuildingMarker(b)
            {
                //HasPhotos = ModelContext.BuildingBinds.Include(bi => bi.Building).Any(bi => bi.Building.Id == b.Id)
            })
            .ToList();

            double avgLat = 0.0, avgLon = 0.0;
            foreach (var b in markers)
            {
                avgLat += b.Latitude;
                avgLon += b.Longitude;
            }
            if (markers.Count != 0)
            {
                avgLat /= markers.Count;
                avgLon /= markers.Count;
                map.Center = (avgLat, avgLon);
            }
            else
            {
                map.Center = (location.Latitude, location.Longitude);
            }
            map.Zoom = 15;
            loaded = true;
            StateHasChanged();
        }

        base.OnAfterRender(firstRender);
    }

    async Task OnMarkerClick(BuildingMarker marker)
    {
        var lat = marker.Latitude;
        var lon = marker.Longitude;
        Guid? buildingId = markers
        .FirstOrDefault(b => b.Latitude == lat && b.Longitude == lon)?.BuildingId;
        if (buildingId is not null)
        {
            await JSRuntime.InvokeVoidAsync("open", $"/buildings/{buildingId}", "_blank");
        }
    }
}